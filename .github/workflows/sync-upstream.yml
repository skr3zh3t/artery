name: Scheduled Upstream Sync

on:
  schedule:
    - cron: '0 0 */14 * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest # slim может не иметь всех нужных инструментов
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Критично: подгружаем всю историю, чтобы Гит нашел связь
          token: ${{ secrets.WORKFLOW_SYNC_TOKEN }}

      - name: Set up Git User
        uses: fregante/setup-git-user@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Fetch Upstream
        id: upstream
        run: |
          git remote add upstream https://github.com/riebl/artery.git
          git fetch upstream master
          echo "hash=$(git rev-parse upstream/master)" >> $GITHUB_OUTPUT

      - name: Check Cache
        id: sync-cache
        uses: actions/cache@v4
        with:
          path: .sync-done
          key: sync-${{ steps.upstream.outputs.hash }}

      - name: Prepare and Merge
        if: steps.sync-cache.outputs.cache-hit != 'true'
        id: sync_logic
        run: |
          # 1. Регистрация драйвера
          git config merge.custom-driver.name "Custom merge driver for Artery/Cavise"
          git config merge.custom-driver.driver "python3 tools/custom_merge.py %O %A %B %P"
          
          # 2. Создаем ветку от текущего main
          BRANCH="sync-upstream-$(date +'%Y-%m-%d')"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          # 3. МЕРДЖ БЕЗ КОНФЛИКТОВ
          # -X theirs подавляет маркеры <<<<<<< и гарантирует "зеленый" PR.
          # Сначала Гит попробует вызвать твой custom-driver. Если он вернет ошибку, 
          # вместо вставки мусора Гит просто возьмет версию файла из апстрима.
          git merge upstream/master --no-ff --allow-unrelated-histories -X theirs -m "Merge upstream changes $(date +'%Y-%m-%d')"
          
          git push origin "$BRANCH" --force

          # 4. ГЕНЕРАЦИЯ ТОП-5 (Только новые изменения)
          # Чтобы не брать всю историю, мы ограничиваем лог 15-ю днями. 
          # Это гарантирует, что в PR попадут только свежие правки Рафаэля.
          {
            echo "body<<EOF"
            echo "### Top 5 Most Impactful Changes (Last 14 days)"
            echo ""
            git log --since="15 days ago" origin/main..upstream/master --pretty=format:"%h|%s" | while read -r line; do
              [ -z "$line" ] && continue
              hash=$(echo "$line" | cut -d'|' -f1)
              stats=$(git show --shortstat "$hash" | tail -n1)
              added=$(echo "$stats" | grep -oP '\d+(?= insertion)' || echo 0)
              deleted=$(echo "$stats" | grep -oP '\d+(?= deletion)' || echo 0)
              echo "$((added + deleted)) $line"
            done | sort -rn | head -n 5 | awk '{$1=""; print "* " $0}'
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "${{ steps.upstream.outputs.hash }}" > .sync-done

      - name: Create Pull Request
        if: steps.sync-cache.outputs.cache-hit != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_SYNC_TOKEN }}
        run: |
          gh pr create \
            --repo ${{ github.repository }} \
            --title "Merge upstream changes ($(date +'%Y-%m-%d'))" \
            --body "${{ steps.sync_logic.outputs.body }}" \
            --base main \
            --head ${{ steps.sync_logic.outputs.branch }}