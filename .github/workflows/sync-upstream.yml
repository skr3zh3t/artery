name: Scheduled Upstream Sync

on:
  schedule:
    - cron: '0 0 */14 * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest # slim может не иметь всех нужных инструментов
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Критично: подгружаем всю историю, чтобы Гит нашел связь
          token: ${{ secrets.WORKFLOW_SYNC_TOKEN }}

      - name: Set up Git User
        uses: fregante/setup-git-user@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Fetch Upstream
        id: upstream
        run: |
          git remote add upstream https://github.com/riebl/artery.git
          git fetch upstream master
          echo "hash=$(git rev-parse upstream/master)" >> $GITHUB_OUTPUT

      - name: Check Cache
        id: sync-cache
        uses: actions/cache@v4
        with:
          path: .sync-done
          key: sync-${{ steps.upstream.outputs.hash }}

      - name: Prepare and Merge
        if: steps.sync-cache.outputs.cache-hit != 'true'
        id: sync_logic
        run: |
          # 1. Настройка драйвера
          git config merge.custom-driver.name "Custom merge driver for Artery/Cavise"
          git config merge.custom-driver.driver "python3 tools/custom_merge.py %O %A %B %P"
          
          BRANCH="sync-upstream-$(date +'%Y-%m-%d')"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          # 2. УМНЫЙ МЕРДЖ
          # Мы используем '-X theirs'. 
          # ПОРЯДОК РАБОТЫ: 
          # 1. Сначала Git вызывает твой Python-драйвер для файлов из .gitattributes.
          # 2. Если драйвер вернул exit 0 — файл чист.
          # 3. Если драйвер вернул exit 1 — Git вставит маркеры <<<<<< (это то, что ты хочешь проверить руками).
          # 4. Для ВСЕХ ОСТАЛЬНЫХ файлов (где нет драйвера) '-X theirs' молча возьмет версию апстрима.
          # Это уберет мусорные конфликты в .github/workflows и прочих системных файлах.
          
          if ! git merge upstream/master --no-ff --allow-unrelated-histories -X theirs -m "Merge upstream changes $(date +'%Y-%m-%d')"; then
            echo "Real conflicts detected by driver. Committing with markers."
            git add .
            git commit -m "Merge upstream with manual conflicts"
          fi
          
          git push origin "$BRANCH" --force

          # 3. ГЕНЕРАЦИЯ ТОП-5 (Только свежее)
          # Чтобы не тащить историю с 2010 года, берем лог самого апстрима за последние 14 дней.
          {
            echo "body<<EOF"
            echo "### Top 5 Recent Changes from Upstream"
            echo ""
            # Берем последние 5 коммитов, которые физически появились в апстриме за 2 недели
            git log --since="14 days ago" upstream/master --pretty=format:"%h|%s" | while read -r line; do
              [ -z "$line" ] && continue
              hash=$(echo "$line" | cut -d'|' -f1)
              stats=$(git show --shortstat "$hash" | tail -n1)
              added=$(echo "$stats" | grep -oP '\d+(?= insertion)' || echo 0)
              deleted=$(echo "$stats" | grep -oP '\d+(?= deletion)' || echo 0)
              echo "$((added + deleted)) $line"
            done | sort -rn | head -n 5 | awk '{$1=""; print "* " $0}'
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "${{ steps.upstream.outputs.hash }}" > .sync-done